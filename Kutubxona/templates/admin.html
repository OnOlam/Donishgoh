{% extends "base.html" %}
{% block content %}

<div class="admin-dashboard">
  <div class="admin-header">
    <h2>‚öôÔ∏è –ü–∞–Ω–µ–ª–∏ –º–∞—ä–º—É—Ä”£</h2>
    <div class="admin-level-badge">
      {% if user.admin_level == 2 %}
        <span class="badge-main-admin">üëë –°–∞—Ä–¥–æ—Ä–∏ –º–∞—ä–º—É—Ä”£</span>
      {% else %}
        <span class="badge-secondary-admin">üõ°Ô∏è –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∏ –æ–¥–¥”£</span>
      {% endif %}
    </div>
  </div>

  <div style="height:24px"></div>

  <!-- Material qo'shish forma -->
  <div class="admin-section">
    <h3>‚ûï –ú–∞–≤–æ–¥–∏ –Ω–∞–≤ –∏–ª–æ–≤–∞ –∫—É–Ω–µ–¥</h3>
    
    <form method="post" action="{{ url_for('admin_add_material') }}" enctype="multipart/form-data" class="admin-form">
      
      <div class="form-grid">
        <div class="form-group">
          <label class="form-label">üè∑Ô∏è –ù–∞–≤—ä–∏ –º–∞–≤–æ–¥ *</label>
          <select class="input" name="material_type" id="materialType" required onchange="updateFileFilter()">
            <option value="book">üìö –ö–∏—Ç–æ–±</option>
            <option value="app">üì± –ë–∞—Ä–Ω–æ–º–∞</option>
            {% if user.admin_level == 2 %}
              <option value="image">üñºÔ∏è –†–∞—Å–º</option>
              <option value="video">üé¨ –í–∏–¥–µ–æ</option>
            {% endif %}
          </select>
          {% if user.admin_level == 1 %}
            <p class="form-hint">‚ö†Ô∏è –®—É–º–æ —Ç–∞–Ω“≥–æ –º–µ—Ç–∞–≤–æ–Ω–µ–¥ –∫–∏—Ç–æ–±“≥–æ –≤–∞ –±–∞—Ä–Ω–æ–º–∞“≥–æ—Ä–æ –±–æ—Ä –∫—É–Ω–µ–¥</p>
          {% endif %}
        </div>

        <div class="form-group">
          <label class="form-label">üìù –£–Ω–≤–æ–Ω *</label>
          <input class="input" name="title" required placeholder="–ù–æ–º–∏ –º–∞–≤–æ–¥...">
        </div>

        <div class="form-group">
          <label class="form-label">üë§ –ú—É–∞–ª–ª–∏—Ñ/–û—Ñ–∞—Ä–∏–¥–≥–æ—Ä</label>
          <input class="input" name="author" placeholder="–ù–æ–º —ë –Ω–æ–º–∏ –∫–æ–º–ø–∞–Ω–∏—è...">
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">üìÑ –¢–∞–≤—Å–∏—Ñ</label>
        <textarea class="input" name="description" rows="4" placeholder="–ú–∞—ä–ª—É–º–æ—Ç–∏ –º—É—Ñ–∞—Å—Å–∞–ª –¥–∞—Ä –±–æ—Ä–∞–∏ –º–∞–≤–æ–¥..."></textarea>
      </div>

      <div class="form-group">
        <label class="form-label">üìé –ë–æ—Ä–∫—É–Ω–∏–∏ —Ñ–∞–π–ª</label>
        <div class="file-upload-wrapper">
          <input type="file" name="file" id="fileInput" class="file-input">
          <label for="fileInput" class="file-label">
            <span class="file-icon">üìÅ</span>
            <span id="fileName">–§–∞–π–ª—Ä–æ –∏–Ω—Ç–∏—Ö–æ–± –∫—É–Ω–µ–¥...</span>
          </label>
        </div>
      </div>

      <button class="btn btn-large btn-success" type="submit">
        ‚úÖ –ú–∞–≤–æ–¥ –∏–ª–æ–≤–∞ –∫—É–Ω–µ–¥
      </button>
    </form>
  </div>

  <div style="height:32px"></div>

  <!-- Materiallar ro'yxati -->
  <div class="admin-section">
    <h3>üì¶ –ú–∞–≤–æ–¥“≥–æ–∏ –º–∞–Ω</h3>
    
    {% if materials %}
      <div class="admin-materials-list">
        {% for m in materials %}
          <div class="admin-material-item">
            <div class="material-item-header">
              <div class="material-item-type">
                {% if m.material_type == 'book' %}üìö
                {% elif m.material_type == 'app' %}üì±
                {% elif m.material_type == 'image' %}üñºÔ∏è
                {% elif m.material_type == 'video' %}üé¨
                {% endif %}
              </div>
              <div class="material-item-info">
                <h4>{{ m.title }}</h4>
                <p class="small">
                  {% if m.author %}üë§ {{ m.author }} ‚Ä¢ {% endif %}
                  üëÅÔ∏è {{ m.view_count }} –¥–∏–¥–∞ —à—É–¥ ‚Ä¢ 
                  üìÖ {{ m.created_at[:10] }}
                </p>
              </div>
            </div>
            
            <div class="material-item-actions">
              <a class="btn btn-sm btn-view" href="{{ url_for('material_detail', material_id=m.id) }}" target="_blank">
                üëÅÔ∏è –ù–∞–º–æ–∏—à
              </a>
              <a class="btn btn-sm btn-stats" href="{{ url_for('admin_material_stats', material_id=m.id) }}">
                üìä –û–º–æ—Ä
              </a>
              <a class="btn btn-sm btn-edit" href="{{ url_for('admin_edit_material', material_id=m.id) }}">
                ‚úèÔ∏è –¢–∞“≥—Ä–∏—Ä
              </a>
              <a class="btn btn-sm btn-delete" href="{{ url_for('admin_delete_material', material_id=m.id) }}" 
                 onclick="return confirm('–ú–∞–≤–æ–¥—Ä–æ –Ω–µ—Å—Ç –∫–∞—Ä–¥–∞–Ω –¥–∞—Ä–∫–æ—Ä–º–∏?')">
                üóëÔ∏è –ù–µ—Å—Ç –∫–∞—Ä–¥–∞–Ω
              </a>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="empty-state-small">
        <p>üì≠ –®—É–º–æ “≥–∞–Ω”Ø–∑ —è–≥–æ–Ω –º–∞–≤–æ–¥ –±–æ—Ä –Ω–∞–∫–∞—Ä–¥–∞–µ–¥..</p>
      </div>
    {% endif %}
  </div>

  <!-- Faqat Bosh Admin uchun -->
  {% if user.admin_level == 2 %}
    <div style="height:32px"></div>
    
    <div class="admin-section">
      <h3>üë• –ò–¥–æ—Ä–∞–∫—É–Ω–∏–∏ –∫–æ—Ä–±–∞—Ä</h3>
      
      {% if users %}
        <div class="users-table-wrapper">
          <table class="admin-table">
            <thead>
              <tr>
                <th>üÜî ID</th>
                <th>üë§ –ù–æ–º</th>
                <th>üìß –ü–æ—á—Ç–∞–∏ —ç–ª–µ–∫—Ç—Ä–æ–Ω”£</th>
                <th>üõ°Ô∏è –°–∞—Ç“≥</th>
                <th>‚öôÔ∏è –ê–º–∞–ª“≥–æ</th>
              </tr>
            </thead>
            <tbody>
              {% for u in users %}
                <tr>
                  <td>#{{ u.id }}</td>
                  <td>{{ u.name }}</td>
                  <td>{{ u.email }}</td>
                  <td>
                    {% if u.admin_level == 2 %}
                      <span class="badge-main-admin">–°–∞—Ä–¥–æ—Ä–∏ –º–∞—ä–º—É—Ä”£</span>
                    {% elif u.admin_level == 1 %}
                      <span class="badge-secondary-admin">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∏ –æ–¥–¥”£</span>
                    {% else %}
                      <span class="badge-user">–ò—Å—Ç–∏—Ñ–æ–¥–∞–±–∞—Ä–∞–Ω–¥–∞</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if u.id != session.get('user_id') and u.admin_level != 2 %}
                      <a class="btn btn-sm btn-toggle" href="{{ url_for('admin_toggle_user', user_id=u.id) }}">
                        {% if u.admin_level == 1 %}
                          ‚ùå –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—Ä–æ –≥–∏—Ä–µ–¥
                        {% else %}
                          ‚úÖ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
                        {% endif %}
                      </a>
                      <a class="btn btn-sm btn-notify" href="{{ url_for('admin_notify_user', user_id=u.id) }}">
                        üí¨ “≤–∞–±–∞—Ä
                      </a>
                    {% elif u.id == session.get('user_id') %}
                      <span class="small muted">–®—É–º–æ</span>
                    {% else %}
                      <span class="small muted">–°–∞—Ä–¥–æ—Ä–∏ –º–∞—ä–º—É—Ä”£</span>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endif %}
    </div>
  {% endif %}
</div>

<script>
// Fayl input o'zgarishini kuzatish
document.getElementById('fileInput').addEventListener('change', function(e) {
  const fileName = e.target.files[0] ? e.target.files[0].name : '–ú–∞–≤–æ–¥—Ä–æ –∏–Ω—Ç–∏“≥–æ–± –∫—É–Ω–µ–¥...';
  document.getElementById('fileName').textContent = fileName;
});

// Material turiga qarab fayl filtrini o'zgartirish
function updateFileFilter() {
  const materialType = document.getElementById('materialType').value;
  const fileInput = document.getElementById('fileInput');
  const fileHint = document.getElementById('fileHint');
  
  const acceptTypes = {
    'book': '.pdf,.epub,.mobi,.djvu,.fb2,.doc,.docx',
    'app': '.apk,.exe,.msi,.dmg,.deb,.rpm',
    'image': '.jpg,.jpeg,.png,.gif,.webp,.svg,.bmp',
    'video': '.mp4,.avi,.mkv,.mov,.wmv,.flv,.webm'
  };
  
  const hintTexts = {
    'book': '–ò“∑–æ–∑–∞—Ç –¥–æ–¥–∞–≥–∏: PDF, EPUB, MOBI, DJVU, FB2, DOC, DOCX',
    'app': '–ò“∑–æ–∑–∞—Ç –¥–æ–¥–∞–≥–∏: APK, EXE, MSI, DMG, DEB, RPM',
    'image': '–ò“∑–æ–∑–∞—Ç –¥–æ–¥–∞–≥–∏: JPG, PNG, GIF, WEBP, SVG, BMP',
    'video': '–ò“∑–æ–∑–∞—Ç –¥–æ–¥–∞–≥–∏: MP4, AVI, MKV, MOV, WMV, FLV, WEBM'
  };
  
  fileInput.setAttribute('accept', acceptTypes[materialType]);
  fileHint.textContent = hintTexts[materialType];
}

// Sahifa yuklanganda fayl filtrini o'rnatish
updateFileFilter();
</script>

{% endblock %}
